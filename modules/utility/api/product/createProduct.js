import{fetchPost}from"/modules/utility/fetch";import{defaultStyle,defaultProduct}from"/modules/ecommerce/product/defaults";export default async function handler(a){if(console.log("Create Product Body",a),a?.apiUrl&&a?.pipelineDbItem){const d=new FormData,i=a.pipelineDbItem??defaultProduct(),m=[];Object.entries(a.pipelineObject).map(e=>{switch(e[0]){case"name":i.name=e[1];break;case"description":i.detailmeta.description=e[1];break;case"eventDate":i?.detailmeta||(i.detailmeta=defaultProduct().detailmeta),i?.detailmeta.eventDateDef||(i.detailmeta.eventDateDef={dates:[],input:"",tags:[]}),i.detailmeta.eventDateDef.dates=[e[1]],i.detailmeta.eventDateDef.input=[e[1].toString()],i?.detailmeta.livestreamDef||(i.detailmeta.livestreamDef={dates:[],input:"",tags:[]}),i.detailmeta.livestreamDef.dates=[e[1]],i.detailmeta.livestreamDef.input=[e[1].toString()];break;case"price":i?.styles||0!=i?.styles.length||(i.styles=[defaultStyle()]),i.styles[0].price=e[1];break;case"quantity":i?.styles||0!=i?.styles.length||(i.styles=[defaultStyle()]),i.styles[0].quantity=e[1];break;case"lineup":Array.isArray(e[1])&&e[1].map(t=>{var e,i=t.modif||"lineup";t.image&&-1<["lineup"].indexOf(i)&&t.id&&(d.append("image",t.image),e=a.imgFor.findIndex(e=>e.id===t.id),console.log("F",e,t,a.imgFor),-1===e&&a.imgFor.push({id:t.id,name:t.image.name,modif:i}),m.push({name:t.name,modif:i,id:t.id,title:t.title,time:t.time,description:t.description}))});break;case"images":Array.isArray(e[1])&&e[1].map(e=>{e.image&&e.name&&-1<["leadImg","featureImg","productImg"].indexOf(e.modif)&&(d.append("image",e.image),m.push({name:e.name,modif:e.modif,id:e.id}))});break;default:i.meta[e[0]]=e[1]}});for(let t=0;t<a.imgFor.length;t++){var e=a.imgCache.getAll("image");e&&(e=e.find(e=>e.name===a.imgFor[t].name))&&(d.append("image",e),e={name:e.name,modif:a.imgFor[t].modif,id:a.imgFor[t]?.id??null},"lineup"===a.imgFor[t].modif&&(e.title=a.imgFor[t].title,e.description=a.imgFor[t].description,e.time=a.imgFor[t].time),m.push(e))}console.log(a),d.append("imgNames",JSON.stringify(m)),d.append("hash",a._loggedIn.hash),d.append("identifier",a._loggedIn.identifier),d.append("product",JSON.stringify(i)),d.append("shop",a?.shop?.id??null),d.append("status","publish"),d.append("existing",a.existing);var t=await fetchPost(a.apiUrl+"/m/publishproduct",null,null,d,{formData:!0});if(t&&t.hasOwnProperty("status")){if("disauthenticated"==t.status)return logout(),"disauthenticated";if("failed"==t.status)return!1;if("success"==t.status)return t}}return!1}