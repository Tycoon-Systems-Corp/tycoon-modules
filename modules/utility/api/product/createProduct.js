import{fetchPost}from"/modules/utility/fetch";import{defaultStyle,defaultProduct}from"/modules/ecommerce/product/defaults";export default async function handler(i){if(console.log("Create Product Body",i),i?.apiUrl&&i?.pipelineDbItem){const a=new FormData,d=i.pipelineDbItem??defaultProduct(),n=[];Object.entries(i.pipelineObject).map(e=>{switch(e[0]){case"name":d.name=e[1];break;case"description":d.detailmeta.description=e[1];break;case"eventDate":d?.detailmeta||(d.detailmeta=defaultProduct().detailmeta),d?.detailmeta.eventDateDef||(d.detailmeta.eventDateDef={dates:[],input:"",tags:[]}),d.detailmeta.eventDateDef.dates=[e[1]],d.detailmeta.eventDateDef.input=[e[1].toString()],d?.detailmeta.livestreamDef||(d.detailmeta.livestreamDef={dates:[],input:"",tags:[]}),d.detailmeta.livestreamDef.dates=[e[1]],d.detailmeta.livestreamDef.input=[e[1].toString()];break;case"price":d?.styles||0!=d?.styles.length||(d.styles=[defaultStyle()]),d.styles[0].price=e[1];break;case"quantity":d?.styles||0!=d?.styles.length||(d.styles=[defaultStyle()]),d.styles[0].quantity=e[1];break;case"lineup":Array.isArray(e[1])&&e[1].map(t=>{t.image&&t.name&&-1<["lineup"].indexOf(t.modif)&&t.id&&(a.append("image",t.image),-1===i.imgFor.findIndex(e=>e.id===t.id)&&i.imgFor.push({name:t.name,modif:"lineup",id:t.id,title:t.title,time:t.time,description:t.description}),n.push({name:t.name,modif:"lineup",id:t.id,title:t.title,time:t.time,description:t.description}))});break;case"images":Array.isArray(e[1])&&e[1].map(e=>{e.image&&e.name&&-1<["leadImg","featureImg","productImg"].indexOf(e.modif)&&(a.append("image",e.image),n.push({name:e.name,modif:e.modif,id:e.id}))});break;default:d.meta[e[0]]=e[1]}});for(let t=0;t<i.imgFor.length;t++){var e=i.imgCache.getAll("image");e&&(e=e.find(e=>e.name===i.imgFor[t].name))&&(a.append("image",e),e={name:e.name,modif:i.imgFor[t].modif,id:i.imgFor[t]?.id??null},"lineup"===i.imgFor[t].modif&&(e.title=i.imgFor[t].title,e.description=i.imgFor[t].description,e.time=i.imgFor[t].time),n.push(e))}console.log(i),a.append("imgNames",JSON.stringify(n)),a.append("hash",i._loggedIn.hash),a.append("identifier",i._loggedIn.identifier),a.append("product",JSON.stringify(d)),a.append("shop",i?.shop?.id??null),a.append("status","publish"),a.append("existing",i.existing);var t=await fetchPost(i.apiUrl+"/m/publishproduct",null,null,a,{formData:!0});if(t&&t.hasOwnProperty("status")){if("disauthenticated"==t.status)return logout(),"disauthenticated";if("failed"==t.status)return!1;if("success"==t.status)return t}}return!1}