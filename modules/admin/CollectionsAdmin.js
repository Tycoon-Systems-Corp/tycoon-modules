function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,l=arguments[t];for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a])}return e}).apply(this,arguments)}import React from"react";import{debounce}from"../util";import{v4 as uuidv4}from"uuid";import AdminStyles from"./Admin.module.scss";import{logout}from"../utility/onboarding/SignIn";import{fetchPost}from"../utility/fetch";import{printRecursiveObject}from"../utility/utility/data";import Tooltip from"@mui/material/Tooltip";import{IndexHello}from"/modules/presentation/hello/IndexHello";const moduleName="DatabaseAdmin",DO_SEARCH_DELAY=1500,Module=o=>{const[t,j]=React.useState(!1),[,L]=React.useState(null),[i,M]=React.useState(null),[n,a]=React.useState(null),[s,d]=React.useState(!1),[u,m]=React.useState(null),[f,U]=React.useState(0),[l,H]=React.useState(0),[g,c]=React.useState(null),[h,p]=React.useState(null),[y,v]=React.useState(null),[K,r]=React.useState(null),[R,b]=React.useState(null),[E,V]=React.useState(null),[T,W]=React.useState(null),[e,C]=React.useState([]),N=React.useRef(),S=React.useRef(),A=React.useRef(),w=(o._LocalEventEmitter.unsubscribe(moduleName),o._LocalEventEmitter.subscribe(moduleName,e=>{var t;e&&("loadDefault"===e.dispatch?w():"search"===e.dispatch&&null!==(t=N?.current?.value)&&x(t,"master"===e.hierarchy?"collections":n,e.hierarchy))}),React.useEffect(()=>{var e;t||(e=uuidv4(),L(e),w(),j(!0))},[t]),async()=>{var e={domainKey:o.domainKey,hash:o._loggedIn.hash,identifier:o._loggedIn.identifier},e=await fetchPost(o.apiUrl+"/a/databasecruddefaults",null,null,e);return!!e&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?(e?.data&&(M(e.data),!n&&e?.data?.model[0]&&e.data.model[0].table&&a(e.data.model[0].table),e?.newModelDefaults)&&W(e.newModelDefaults),e):void 0):void 0)}),$=React.useCallback(e=>{e?.currentTarget?.getAttribute&&(e=e.currentTarget.getAttribute("modif"))&&(a(e),setTimeout(()=>{o._LocalEventEmitter.dispatch(moduleName,{dispatch:"search"})},150))}),x=async(e,t,a)=>{let l;try{var c,r;if(!s)return l=setTimeout(()=>{d(!1)},1e4),c={domainKey:o.domainKey,hash:o._loggedIn.hash,identifier:o._loggedIn.identifier,table:t,value:e,offset:f},(r=await fetchPost(o.apiUrl+"/a/databaserecordssearch",null,null,c))?r.hasOwnProperty("status")?(d(!1),clearTimeout(l),"disauthenticated"==r.status?(logout(),"disauthenticated"):"failed"!=r.status&&("success"==r.status?(r?.data&&("master"===a?V:m)(r.data),r):void 0)):void 0:(d(!1),clearTimeout(l),!1)}catch(e){d(!1),clearTimeout(l)}};var _=React.useCallback(debounce(e=>{var t;e?.target&&(t=e.target.value,e=e.target.getAttribute("hierarchy"),void 0!==t)&&(B(),x(t,"master"===e?"collections":n,e))},DO_SEARCH_DELAY),[n]);const k=React.useCallback(e=>{var t=e.currentTarget.getAttribute("scope");const a=e.currentTarget.getAttribute("hierarchy");t&&(e=e.currentTarget.getAttribute("i"),"itemOffset"===t&&("master"===a?H:U)(Number(e)),setTimeout(()=>{o._LocalEventEmitter.dispatch(moduleName,{dispatch:"search",hierarchy:a})},150))}),I=React.useCallback(e=>{if(B(),e?.currentTarget?.getAttribute){const a=e.currentTarget.getAttribute("modif");var t,e=e.currentTarget.getAttribute("collection");a&&(t=e?E.find(e=>e.id===a):u.find(e=>e.id===a))&&(e?p({model:"collection",record:t,config:i?.model?.find(e=>"collection"===e.table)}):c({model:n,record:t,config:i?.model?.find(e=>e.table===n)}))}});var Y=React.useCallback(e=>{P(e,"collection")}),F=React.useCallback(e=>{P(e)});const P=React.useCallback((e,a)=>{if(B(),e?.currentTarget?.getAttribute){const i=e.currentTarget.getAttribute("i");var l=e.currentTarget.getAttribute("modif");const n=e.currentTarget.getAttribute("array");var e=e.currentTarget.getAttribute("parentarr"),c=("collection"===a?h:g)?.record;if("edit"===l){if(i){console.log(i,c,o);let t=c;const o=i.split(".");for(let e=0;e<o.length;e++)t=t[o[e]];console.log(S.current),v(null),setTimeout(()=>{v({reference:i,cur:t,arr:n,useType:a})},100)}}else if("add"===l&&i){let t=c;var r=i.split(".");if(console.log(l,n,e,t,r),1<r.length&&r.pop(),e){for(let e=0;e<r.length;e++)t=t[r[e]];console.log(t,n,i,r.join(".")),v({reference:r.join("."),cur:t,arr:n,useType:a})}else b({reference:r.join("."),field:"",value:"",useType:a})}}}),O=(e,t,a,l,c)=>c&&!e[t[a]]||e&&e[t[a]]&&a===t.length-1?(e[t[a]]=l,e):O(e[t[a]],t,a+1,l,c),q=async(e,t,a=0,l=40)=>{var c,r,i;try{if(!s)return d(!0),c=setTimeout(()=>{d(!1)},1e4),r={collection:e,childModel:t,offset:a,limit:l},(i=await fetchPost(o.apiUrl+"/p/getrelationshipchildren",null,null,r))?i.hasOwnProperty("status")?(d(!1),clearTimeout(c),"disauthenticated"==i.status?(logout(),"disauthenticated"):"failed"==i.status?(setInvoiceData(null),!1):"success"==i.status?(console.log(i),i):void 0):void d(!1):(d(!1),clearTimeout(c),!1)}catch(e){d(!1)}},z=async(e,t,a)=>{var l,c,r;try{if(!s)return d(!0),l=setTimeout(()=>{d(!1)},1e4),c={hash:o._loggedIn.hash,identifier:t,collection:e,existing:a},(r=await fetchPost(o.apiUrl+"/p/updatecollection",null,null,c))?r.hasOwnProperty("status")?(d(!1),clearTimeout(l),"disauthenticated"==r.status?(logout(),"disauthenticated"):"failed"==r.status?(setInvoiceData(null),!1):"success"==r.status?r:void 0):void d(!1):(d(!1),clearTimeout(l),!1)}catch(e){d(!1)}};var G=React.useCallback(async e=>{var t,a;(h?.record?.type===n||""===h?.record?.type)&&g?.record&&(t={...h},(a=await(async(e,t,a,l,c)=>{var r,i,n;try{if(!s)return d(!0),r=setTimeout(()=>{d(!1)},1e4),i={hash:o._loggedIn.hash,identifier:o._loggedIn.identifier,collection:e,record:t,aModel:a,association:l,add:c},(n=await fetchPost(o.apiUrl+"/a/addtocollection",null,null,i))?n.hasOwnProperty("status")?(d(!1),clearTimeout(r),"disauthenticated"==n.status?(logout(),"disauthenticated"):"failed"==n.status?(setInvoiceData(null),!1):"success"==n.status?(console.log(n),n):void 0):void d(!1):(d(!1),clearTimeout(r),!1)}catch(e){d(!1)}})(h.record.id,g.record.id,g.model,"childof",!0))?.data?.collection)&&(t.record=a.data.collection,p(t),(a=await q(t.record.id,g?.model??t.record.type))?.data)&&(c({model:n,record:a.data.find(e=>e.id===g.record.id),config:i?.model?.find(e=>e.table===n)}),C(a.data))}),D=React.useCallback(async a=>{if(a?.currentTarget?.getAttribute){a=a.currentTarget.getAttribute("modif");if("cancel"===a)v(null),b(null);else if("set"===a){let e=S.current.value;y?.arr&&(e=e.split(","));var l,a=("collection"===y?.useType||"collection"===R?.useType?h:g).record;console.log("Obj",a);let t;R?.reference&&A?.current?.value?(t=R.reference.split(".")).push(A.current.value):t=y.reference.split("."),a=O(a,t,0,e,!!R?.reference&&A.current.value),console.log(y,h),"collection"===y?.useType||"collection"===R?.useType?(console.log(a,h),l=(await z(h.record,o._loggedIn.identifier,h.record.id))?.data??h.record,p({model:"collection",record:l,config:i?.model?.find(e=>"collection"===e.table)})):(r(g),(async e=>{let a;try{if(null===e.id&&"collection"===y?.useType)return!p({model:"collection",record:e,config:i?.model?.find(e=>"collection"===e.table)});if(!s){a=setTimeout(()=>{d(!1)},1e4);var l,c,r={domainKey:o.domainKey,hash:o._loggedIn.hash,identifier:o._loggedIn.identifier,table:n,record:e??K,recordid:e?.id};let t=await fetchPost(o.apiUrl+"/a/databasecrudupdate",null,null,r);return t?t.hasOwnProperty("status")?(d(!1),clearTimeout(a),"disauthenticated"==t.status?(logout(),"disauthenticated"):"failed"!=t.status&&("success"==t.status?(t?.data&&(console.log(t.data),-1<(c=(l=u).findIndex(e=>e.id===t.data.id))&&(l[c]=t.data),console.log(l[c]),m(l)),t):void 0)):void 0:(d(!1),clearTimeout(a),!1)}}catch(e){d(!1),clearTimeout(a)}})(a)),v(null),b(null)}}});const B=()=>{b(null),v(null),r(null)},J=e=>e.title&&""!==e?.title?e.title:e.name&&""!==e?.name?e.name:e.username&&""!==e?.username?e.username:e.id;var Q=React.useCallback(async e=>{var t;!h&&T?.Collection&&((t=structuredClone(T.Collection)).author=o?._loggedIn.identifier,(t=await z(t,o?._loggedIn?.identifier))?.data)&&p({model:"collection",record:t.data,config:i?.model?.find(e=>"collection"===e.table)})}),X=React.useCallback(async e=>{var e=e?.currentTarget?.getAttribute("record");e&&(await(async(e,t,a,l)=>{var c,r,i;try{if(!s)return d(!0),c=setTimeout(()=>{d(!1)},1e4),r={hash:o._loggedIn.hash,identifier:o._loggedIn.identifier,a:e,b:a,verb:l,atype:t},(i=await fetchPost(o.apiUrl+"/a/deleterelationshipbyab",null,null,r))?i.hasOwnProperty("status")?(d(!1),clearTimeout(c),"disauthenticated"==i.status?(logout(),"disauthenticated"):"failed"==i.status?(setInvoiceData(null),!1):"success"==i.status?i:void 0):void d(!1):(d(!1),clearTimeout(c),!1)}catch(e){d(!1)}})(e,n,h?.record?.id,"childof"),e={...h},(e=await q(e.record.id,g?.model??e.record.type))?.data)&&(c({model:n,record:e.data.find(e=>e.id===g.record.id),config:i?.model?.find(e=>e.table===n)}),C(e.data))}),Z=[f-2,f-1,f,f+1,f+2],ee=[l-2,l-1,l,l+1,l+2],te=React.useMemo(()=>React.createElement("div",null,"video"===g?.model&&g?.record?.thumbtrack?.[0]?React.createElement("img",{className:""+AdminStyles.previewContainer,style:{width:"-webkit-fill-available"},src:o?.cdn?.static+"/thumbtrack/"+g.record.thumbtrack[0]}):null),[g?.record,o?.cdn?.static]);return console.log("Database",i,n,u,g,h,y,e),React.createElement("div",{className:`${o.className} ${moduleName}_Container`,style:{marginRight:".5rem"}},React.createElement(Tooltip,{title:"Create collections of any type to be manipulated and used in any way on the platform. Try making a list of videos or articles or even a course.",placement:"right"},React.createElement("h3",{style:{width:"fit-content"}},"Collections")),React.createElement("div",{style:{background:"$1f1f1f",borderRadius:"1rem"}},React.createElement(IndexHello,_extends({},o,{style:{marginBottom:".5rem",paddingTop:".5rem"},groupLabel:h?.record?.title??"",items:e??[],tight:!0,action:X,actionLabel:"Delete"}))),React.createElement("div",{className:""+AdminStyles.containerTwoSmallRight},React.createElement("div",null,React.createElement("div",null,R?React.createElement("div",{className:""+AdminStyles.crudUpdateContainer},React.createElement("div",{style:{marginBottom:".25rem"}},"New field under ",R?.reference," of ","collection"===R?.useType?"collection":g?.model," ",("collection"===R?.useType?h:g)?.record?.id),React.createElement("div",{className:"flex gap-p5"},React.createElement("input",{type:"text",placeholder:"Set Field",ref:A,defaultValue:y?.cur,className:""+AdminStyles.input,style:{width:"100%",marginBottom:".25rem"}}),React.createElement("input",{type:"text",placeholder:"Set Value",ref:S,defaultValue:y?.cur,className:""+AdminStyles.input,style:{width:"100%",marginBottom:".25rem"}})),React.createElement("div",{className:"flex gap-p2"},React.createElement("button",{onClick:D,modif:"set"},"Set"),React.createElement("button",{onClick:D,modif:"cancel"},"Cancel"))):null),React.createElement("div",null,y?React.createElement("div",{className:""+AdminStyles.crudUpdateContainer},React.createElement("div",{style:{marginBottom:".25rem"}},y?.reference," of ","collection"===y?.useType?"collection":g?.model," ",("collection"===y?.useType?h:g)?.record?.id),y?.arr?React.createElement("div",null,"Comma separated list of values"):null,React.createElement("input",{type:"text",placeholder:"Set Value",ref:S,defaultValue:y?.cur,className:""+AdminStyles.inputSearch,style:{width:"100%",marginBottom:".25rem"}}),React.createElement("div",{className:"flex gap-p2"},React.createElement("button",{onClick:D,modif:"set"},"Set"),React.createElement("button",{onClick:D,modif:"cancel"},"Cancel"))):null),React.createElement("div",null,React.createElement("div",{className:"flex gap-p5",style:{flexDirection:"column"}},h?React.createElement("div",{className:""+AdminStyles.crudContainer},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("p",null,"collection")),React.createElement("div",{className:h?.record?"record_box":""},printRecursiveObject(h?.record,0,i?.model?.find(e=>"collection"===e.table),"",Y)),g?null:React.createElement("div",{className:"info_box",style:{marginTop:".5rem",fontWeight:700}},"Select child record to add to collection")):null,g?.record?React.createElement("div",{className:""+AdminStyles.crudContainer},h?null:React.createElement("div",{className:"info_box",style:{marginBottom:".5rem",fontWeight:700}},"Select or create a  collection to add to"),React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("p",null,g?.model),h&&-1===e?.findIndex(e=>e.id===g.record.id)&&g&&(h?.record?.type===n||""===h?.record?.type)&&g?.record?.__typename?.toLowerCase()===n?React.createElement("button",{onClick:G,record:g?.record?.id},"Add to collection"):null),React.createElement("div",null,te),React.createElement("h4",null,g?.record?.title??g?.record?.name??g?.record?.username??g?.record?.id),React.createElement("div",{className:"record_box"},printRecursiveObject(g.record,0,g?.config,"",F))):null))),React.createElement("div",{className:"flex",style:{flexDirection:"column",minHeight:"85vh"}},React.createElement("div",{className:"Editor_Container Editor_MaxWidth",style:{minHeight:"35vh"}},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("h4",{style:{marginBottom:0}},"Parent"),h?null:React.createElement("button",{onClick:Q},"New")),React.createElement("section",null,React.createElement("div",null,React.createElement("input",{type:"text",placeholder:"Search Records",ref:N,className:""+AdminStyles.inputSearch,style:{width:"100%"},hierarchy:"master",onChange:_})),React.createElement("div",{className:"flex",style:{flexDirection:"column",gap:".25rem"}},E?.map?E.map(e=>React.createElement("div",{className:""+AdminStyles.itemContainer,style:{cursor:"pointer"},onClick:I,modif:e.id,collection:"collection"},React.createElement("div",null,J(e)))):null),React.createElement("ul",{className:"PaginationContainer"},ee.map((e,t)=>-1<e?React.createElement("li",{className:e==l?"ActivePage":"",scope:"itemOffset",hierarchy:"master",key:t,i:e,onClick:k},e+1):null)))),React.createElement("div",{className:"Editor_Container Editor_MaxWidth",style:{height:"35vh"}},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("h4",{style:{marginBottom:0}},"Child")),React.createElement("div",{className:"tagContainer",style:{marginBottom:".5rem"}},i?.model?.map?i.model.map((e,t)=>React.createElement("div",{className:"tagItem "+(n===e?.table?"tagItemSelected":null),style:{cursor:"pointer"},modif:e?.table,onClick:$},e?.table)):null),React.createElement("section",{style:{height:"inherit"}},React.createElement("div",null,React.createElement("input",{type:"text",placeholder:"Search Records",ref:N,className:""+AdminStyles.inputSearch,style:{width:"100%"},hierarchy:"slave",onChange:_})),React.createElement("div",{className:"flex",style:{height:"inherit",overflow:"auto",flexDirection:"column",gap:".25rem"}},u?.map?u.map(e=>React.createElement("div",{className:""+AdminStyles.itemContainer,style:{cursor:"pointer"},onClick:I,modif:e.id},React.createElement("div",null,J(e)))):null),React.createElement("ul",{className:"PaginationContainer"},Z.map((e,t)=>-1<e?React.createElement("li",{className:e==f?"ActivePage":"",scope:"itemOffset",hierarchy:"slave",key:t,i:e,onClick:k},e+1):null)))))))};export default Module;