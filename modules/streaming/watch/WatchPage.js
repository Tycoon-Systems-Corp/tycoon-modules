function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a,c=arguments[e];for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a])}return t}).apply(this,arguments)}import React from"react";import dynamic from"next/dynamic";import WatchPageStyles from"./WatchPage.module.scss";import{useRouter}from"next/router";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream,checkAuthorization}from"../../utility/streaming";import{ensureAutoPlay,ensureSetSource}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia,isObjectEmpty}from"../../util";import{initializePlayer,disposePlayer,initButtons}from"/modules/streaming/watch/runtime/initialize";import{checkiOS}from"/modules/util";import{resolveContentDate}from"../../utility/utility/date";const Watch=dynamic(()=>import("/layout/Watch"),{ssr:!1}),defaultPoster="img/internal/videoposter.png";let options={autoplay:!0};const Module=r=>{const s=useRouter()["query"],[a,I]=React.useState(!1),[n,,]=React.useState("main-player"),[e,j]=React.useState(!1),[c,z]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[t,B]=React.useState(""),[i,H]=React.useState(!1);var[o,N]=React.useState(!1);const[l,W]=React.useState({}),[u,d]=React.useState({});var[,,]=React.useState(null);const[h,F]=React.useState({}),[m,p]=React.useState(defaultPoster),[y,w]=React.useState(!1),[V,g]=React.useState(!1),[v,f]=React.useState(!1),[D,R]=React.useState(!1),[S,E]=React.useState(!1);var[,,]=React.useState([]);const[q,b]=React.useState(!1),[_,L]=React.useState(null),[P,k]=React.useState(!1);let A=React.useRef();React.useRef(),React.useRef(),React.useRef();const M=React.useRef(),T=i||o,O=r.watchData,x=()=>{r._LocalEventEmitter.dispatch("video_set_chat_state",{})},[J,K]=React.useState([{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",id:"player-btn-chat",btnEvent:x}]),Y=(React.useEffect(()=>{let t=[{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",id:"player-btn-chat",btnEvent:x}];t=r?.appendButtons?t.push(r.appendButtons):r.overrideButtons??t,K(t)},[r?.appendButtons,r?.overrideButtons]),n&&(r._LocalEventEmitter.unsubscribe(n),r._LocalEventEmitter.subscribe(n,t=>{if(t&&t.dispatch)if(A?.current?.muted&&A?.current?.muted()!==P&&k(A.current.muted()),"updateAuth"===t.dispatch){if(et(),!r?.watchData||isObjectEmpty(r.watchData))return null;!T&&M?.current?(e={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",l),A?.current?.src&&(A.current.src({src:"",type:"application/x-mpegURL"}),A.current.pause()),l&&(l.password&&(e.password="The stream requires a password"),l.tags)&&l.dates&&(0<l.tags.length||0<l.dates.length)&&(e.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",e.tagsList=l.tags.map(t=>t)+" "+l.dates.map(t=>t)),d(e)):T||d({})}else if("attemptAutoPlay"===t.dispatch){if(A?.current&&""!==A?.current.src()){console.log("Attempt Play",A.current,c);try{window?.userInteracted||A.current.muted(!0)}catch(t){}A.current.play().catch(t=>{console.log(t,t.message)})}}else{var e;"ensurePosterUpdated"===t.dispatch?r?.watchData&&r?.watchData?.thumbtrack&&r?.watchData?.thumbtrack[0]&&r?.cdn?.static&&(e=r.cdn.static+"/thumbtrack/"+r.watchData.thumbtrack[0],m!==e)&&p(e):"playerHealth"===t.dispatch?(console.log("Player Health",r.cdn,A.current,A.current?.paused(),_),!window?.imaAdManagerDidLoad&&r?.noAds||(_?.message?.match("Playback cannot continue")&&A?.current?.paused()||A?.current?.errorDisplay?.el()?.innerHTML.match("Playback cannot continue")||A?.current?.errorDisplay?.el()?.innerHTML.match("The media could not be loaded")&&S?(L(null),A.current.src({}),ensureSetSource(A.current,c,O,r.cdn.static,!0,()=>{try{window?.userInteracted||A.current.muted(!0)}catch(t){}A.current.play()})):A?.current&&r?.cdn?.static?ensureSetSource(A.current,c,O,r.cdn.static):A.current||q||((e=Y("player-"+n))?(f(!0),A.current=e):(disposePlayer("player-"+n),b(!0),setTimeout(()=>{console.log("Fire Reload"),r._LocalEventEmitter.dispatch(n,{dispatch:"rebuildPlayer"})},50))))):"rebuildPlayer"===t.dispatch?(console.log("Reload Player"),b(!1),Z()):"checkLoad"===t.dispatch&&(console.log("v",A?.current,v,window?.imaAdManagerDidLoad),a)&&!v&&n&&r?.cdn?.static&&window?.videojs&&(window?.imaAdManagerDidLoad||!r?.noAds)&&(R(!0),A.current=initializePlayer(r,r.watchData,c,"player-"+n,options,A,J,G,Q,f,$,E,S,X))}})),t=>{try{if(window?.videojs?.players[t])return window.videojs.players[t]}catch(t){}return null}),G=t=>{console.log("Error",t),L({time:(new Date).getTime(),message:t?.message??""})},Q=t=>{console.log("Ended",t)},X=t=>{console.log("Played",t)},Z=t=>{t=Object.assign(options,{force:t});!window?.imaAdManagerDidLoad&&r?.noAds||(A.current=initializePlayer(r,r.watchData,c,"player-"+n,t,A,J,G,Q,f,$,E,S,X))},$=(React.useEffect(()=>{r?._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("video_set_chat_state"),r._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",y),w(!y)}))},[r._LocalEventEmitter,y]),React.useEffect(()=>{(async()=>{var t;e||r.watchData&&r.watchData.id&&(!h.stream||h.stream&&h.stream!==r.watchData.id)&&(j(!0),t=await doFetchAuthForStream(r.apiUrl,r.domainKey,r.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&F({stream:r.watchData.id,allowed:t.allowed||!1,meta:t.meta,products:t?.products??[]})})()},[r.watchData,h,e]),async(t,e)=>{var a,c;T&&(c={},s?.time&&(c.time=s.time),c?.time&&t?.currentTime&&t.currentTime(c.time),a="live"==(e="Live"==(c=e??r?.watchData)?.__typename?"live":"static")||checkiOS()?"hls":"mpd",c)&&r?.cdn?.static&&(e="static"==e?r.cdn.static+"/video/"+c[a]:""+c?.meta?.channel?.playbackUrl)&&(t.src({src:e,type:"hls"==a?"application/x-mpegURL":"application/dash+xml"}),await ensureAutoPlay(t.play,t),setTimeout(()=>{r._LocalEventEmitter.dispatch(n,{dispatch:"attemptAutoPlay"})},1))});let U=n;React.useEffect(()=>{console.log("did mount",a,v,n,window.videojs);try{if(!a){I((new Date).getTime()),disposePlayer("player-"+n);const t=U;setInterval(()=>{r._LocalEventEmitter.dispatch(t,{dispatch:"updateAuth"})},2e3),setInterval(()=>{r._LocalEventEmitter.dispatch(t,{dispatch:"playerHealth"})},15e3),setInterval(()=>{r._LocalEventEmitter.dispatch(t,{dispatch:"checkLoad"})},2500)}}catch(t){}},[a,A.current,c,r.cdn,r.watchData,v,n,T,i]);const tt=()=>{u?.type&&["prompt","auth"].indexOf(u.type)&&(console.log("Reset prompt"),d({}))},et=(React.useEffect(()=>{let t;var e;"Live"==O?.__typename&&O?.id?(w(!0),O?.meta?.channel?.playbackUrl&&c.src!==O.meta.channel.playbackUrl&&(t=O.meta.channel.playbackUrl)):"Video"==O?.__typename&&(w(!1),e=checkiOS()?"hls":"mpd",O)&&O[e]&&r?.cdn?.static&&(e=r.cdn.static+"/video/"+O[e],c.src!==e)&&(t=e),t&&c.src!==t&&((e={...c}).src=t,z(e),handleInteractMedia(r,r.watchData,e.trying))},[r.watchData,A.current,c?.src,O]),React.useEffect(()=>{c?.src&&t!==c.src&&B(c.src)},[A?.current,c?.src,T,i,t,O,u]),console.log(A?.current),A?.current&&A?.current.src()!==c?.src&&O&&(C="live"==("Live"==O?.__typename?"live":"static")||checkiOS()?"hls":"mpd",A.current.src({src:t,type:"hls"==C?"application/x-mpegURL":"application/dash+xml"})),console.log("Relevant Data",r.watchData,h),()=>{var t,e,a;r.watchData&&(t=checkAuthorization(r.watchData,h,r,tt,T),console.log("check auth",t),r.watchData.meta&&r.watchData.meta.streamSettings&&JSON.stringify(r.watchData.meta.streamSettings)!==JSON.stringify(l)&&W(r.watchData.meta.streamSettings),console.log(T,t,c),T!==t)&&(e=r.watchData?.meta?.channel&&r.watchData.meta?.channel?.playbackUrl&&c?.src===r.watchData.meta.channel.playbackUrl,a=r?.watchData?.hls||r?.watchData?.mpd,console.log(e,a,r),e||a)&&(H(t),t&&tt(),console.log("Auth",t))});React.useEffect(()=>{et()},[c,T,i,r?.watchData,A?.current,h,r?._loggedIn?.identifier]);React.useEffect(()=>{var t;r?.watchData&&r?.watchData?.thumbtrack&&r?.watchData?.thumbtrack[0]&&r?.cdn?.static&&(t=r.cdn.static+"/thumbtrack/"+r.watchData.thumbtrack[0],m!==t)&&(p(t),setTimeout(()=>{console.log(r._LocalEventEmitter,n),r?._LocalEventEmitter&&r._LocalEventEmitter.dispatch(n,{dispatch:"ensurePosterUpdated"})},250))},[r?.watchData,r?.cdn?.static,n,m]);var C={id:r?.watchData?.id,authorData:r?.watchData?.authorData??{},donateTo:r?.watchData?.author??"",date:r?.watchData?.publish?resolveContentDate(r.watchData.publish):"",title:r?.watchData?.title??"",description:r?.watchData?.description??"",tags:r?.watchData?.tags??[],relevantTicket:h},at=(A?.current&&(v||f(!0),D||R(!0)),r.menuConfig&&r.menuConfig.height?r.menuConfig.height+2+"px":"35px");return console.log(A?.current,T,h),React.createElement("div",{className:r.className+" WatchPage_Container"},React.createElement(Watch,_extends({},r,{chatState:y,handleSetMobileStyleConfigs:t=>{V!==t&&g(t)},menuHeight:at,currentPoster:m,streamLeadPrompt:u,authContainer:M,WatchPageStyles:WatchPageStyles,watchMeta:C,playerInitialized:v,playerVisible:D,playerName:U?"player-"+U:null,setMobileStyleConfigs:g,enforceAuth:o,setEnforceAuth:N,muted:P,handleSetMuted:t=>{A?.current?.muted&&(t=!!t,A.current.muted(t),k(t))}})))};export default Module;