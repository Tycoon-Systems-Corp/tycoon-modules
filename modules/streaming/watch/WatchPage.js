function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a,c=arguments[e];for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a])}return t}).apply(this,arguments)}import React from"react";import WatchPageStyles from"./WatchPage.module.scss";import{useRouter}from"next/router";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream,checkAuthorization}from"../../utility/streaming";import{ensureAutoPlay,ensureSetSource}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia,isObjectEmpty}from"../../util";import{initializePlayer,disposePlayer}from"/modules/streaming/watch/runtime/initialize";import{checkiOS}from"/modules/util";import{Watch}from"/layout";import{resolveContentDate}from"../../utility/utility/date";const defaultPoster="img/internal/videoposter.png";let options={autoplay:!0};const Module=r=>{const s=useRouter()["query"],[a,c]=React.useState(!1),[n,z]=React.useState(null),[e,C]=React.useState(!1),[i,I]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[o,H]=React.useState(""),[t,W]=React.useState(!1);var[l,F]=React.useState(!1);const[u,N]=React.useState({}),[h,d]=React.useState({});var[,,]=React.useState(null);const[m,q]=React.useState({}),[V,B]=React.useState(defaultPoster),[p,y]=React.useState(!1),[K,g]=React.useState(!1),[w,v]=React.useState(!1),[Y,G]=React.useState(!1),[f,R]=React.useState(!1);var[,,]=React.useState([]);const[J,D]=React.useState(!1),[Q,S]=React.useState(null),[E,b]=React.useState(!1);let _=React.useRef();React.useRef(),React.useRef(),React.useRef();const P=React.useRef(),L=t||l,k=r.watchData,X=(n&&(r._LocalEventEmitter.unsubscribe(n),r._LocalEventEmitter.subscribe(n,t=>{if(t&&t.dispatch)if(_?.current?.muted&&_?.current?.muted()!==E&&b(_.current.muted()),"updateAuth"===t.dispatch){if(M(),!r?.watchData||isObjectEmpty(r.watchData))return null;!L&&P?.current?(e={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",u),_?.current?.src&&(_.current.src({src:"",type:"application/x-mpegURL"}),_.current.pause()),u&&(u.password&&(e.password="The stream requires a password"),u.tags)&&u.dates&&(0<u.tags.length||0<u.dates.length)&&(e.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",e.tagsList=u.tags.map(t=>t)+" "+u.dates.map(t=>t)),d(e)):L||d({})}else{var e;"attemptAutoPlay"===t.dispatch?_?.current&&""!==_?.current.src()&&(console.log("Attempt Play",_.current,i),_.current.play().catch(t=>{console.log(t,t.message),/failed because the user didn\'t interact with the document first/.test(t.toString())&&(_.current.muted(!0),console.log("Attemt play muted",_.current),_.current.play().catch(t=>{console.log(t)}))})):"ensurePosterUpdated"===t.dispatch?_?.current||O(!0):"playerHealth"===t.dispatch?(console.log("Player Health",r.cdn,_.current,_.current?.paused()),L&&(Q?.message?.match("Playback cannot continue")&&_?.current?.paused()||_?.current?.errorDisplay?.el()?.innerHTML.match("Playback cannot continue")||_?.current?.errorDisplay?.el()?.innerHTML.match("The media could not be loaded")&&f?(S(null),_.current.src({}),ensureSetSource(_.current,i,k,r.cdn.static,!0,()=>{_.current.play()})):_?.current&&r?.cdn?.static?ensureSetSource(_.current,i,k,r.cdn.static):_.current||J||((e=X("player-"+n))?(v(!0),_.current=e):(disposePlayer("player-"+n),D(!0),setTimeout(()=>{console.log("Fire Reload"),r._LocalEventEmitter.dispatch(n,{dispatch:"rebuildPlayer"})},50))))):"rebuildPlayer"===t.dispatch&&(console.log("Reload Player"),D(!1),O())}})),t=>{try{if(window?.videojs?.players[t])return window.videojs.players[t]}catch(t){}return null}),A=t=>{console.log("Error",t),S({time:(new Date).getTime(),message:t?.message??""})},T=t=>{console.log("Ended",t)},x=t=>{console.log("Played",t)},O=t=>{t=Object.assign(options,{force:t});_.current=initializePlayer(r,r.watchData,i,"player-"+n,t,_,[],A,T,v,U,R,f,x)},U=(React.useEffect(()=>{r?._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("video_set_chat_state"),r._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",p),y(!p)}))},[r._LocalEventEmitter,p]),React.useEffect(()=>{(async()=>{var t;e||r.watchData&&r.watchData.id&&(!m.stream||m.stream&&m.stream!==r.watchData.id)&&(C(!0),t=await doFetchAuthForStream(r.apiUrl,r.domainKey,r.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&q({stream:r.watchData.id,allowed:t.allowed||!1,meta:t.meta,products:t?.products??[]})})()},[r.watchData,m,e]),async(t,e)=>{var a,c;L&&(c={},s?.time&&(c.time=s.time),c?.time&&t?.currentTime&&t.currentTime(c.time),a="live"==(e="Live"==(c=e??r?.watchData)?.__typename?"live":"static")||checkiOS()?"hls":"mpd",c)&&r?.cdn?.static&&(e="static"==e?r.cdn.static+"/video/"+c[a]:""+c?.meta?.channel?.playbackUrl)&&(t.src({src:e,type:"hls"==a?"application/x-mpegURL":"application/dash+xml"}),await ensureAutoPlay(t.play,t),setTimeout(()=>{r._LocalEventEmitter.dispatch(n,{dispatch:"attemptAutoPlay"})},1))}),Z=()=>{r._LocalEventEmitter.dispatch("video_set_chat_state",{})},j=(React.useEffect(()=>{console.log("did mount",a,w,n,window.videojs);try{if(!a&&window?.videojs){c((new Date).getTime());const e=uuidv4();z(e),setInterval(()=>{r._LocalEventEmitter.dispatch(e,{dispatch:"updateAuth"})},2500),setInterval(()=>{r._LocalEventEmitter.dispatch(e,{dispatch:"playerHealth"})},15e3)}else{var t;a&&!w&&n&&r?.cdn?.static&&window?.videojs&&(G(!0),L)&&(t=[{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",btnEvent:Z}],_.current=initializePlayer(r,r.watchData,i,"player-"+n,options,_,t,A,T,v,U,R,f,x))}}catch(t){}},[a,_.current,i,r.cdn,r.watchData,w,n,L,t]),()=>{console.log("strea",h),h?.type&&["prompt","auth"].indexOf(h.type)&&(console.log("Reset prompt"),d({}))}),M=(React.useEffect(()=>{let t;var e;"Live"==k?.__typename&&k?.id?(y(!0),k?.meta?.channel?.playbackUrl&&i.src!==k.meta.channel.playbackUrl&&(t=k.meta.channel.playbackUrl)):"Video"==k?.__typename&&(y(!1),e=checkiOS()?"hls":"mpd",k)&&k[e]&&r?.cdn?.static&&(e=r.cdn.static+"/video/"+k[e],i.src!==e)&&(t=e),t&&i.src!==t&&((e={...i}).src=t,I(e),handleInteractMedia(r,r.watchData,e.trying))},[r.watchData,_.current,i?.src,k]),React.useEffect(()=>{var t;i?.src&&L&&o!==i.src&&(t="hls"==("live"==("Live"==k?.__typename?"live":"static")||checkiOS()?"hls":"mpd")?"application/x-mpegURL":"application/dash+xml",H(i.src),_?.current)&&_.current.src({src:i.src,type:t})},[_?.current,i?.src,L,t,o,k,h]),console.log("Relevant Data",r.watchData,m),()=>{var t,e,a;r.watchData&&(t=checkAuthorization(r.watchData,m,r,j,L),console.log("check auth",t),r.watchData.meta&&r.watchData.meta.streamSettings&&N(r.watchData.meta.streamSettings),console.log(L,t,i),L!==t)&&(e=r.watchData?.meta?.channel&&r.watchData.meta?.channel?.playbackUrl&&i?.src===r.watchData.meta.channel.playbackUrl,a=r?.watchData?.hls||r?.watchData?.mpd,console.log(e,a,r),e||a)&&(W(t),t&&j(),console.log("Auth",t))});React.useEffect(()=>{M()},[i,L,t,r?.watchData,_?.current,m,r?._loggedIn?.identifier]);React.useEffect(()=>{r?.watchData&&r?.watchData?.thumbtrack&&r?.watchData?.thumbtrack[0]&&r?.cdn?.static&&(B(r.cdn.static+"/thumbtrack/"+r.watchData.thumbtrack[0]),setTimeout(()=>{console.log(r._LocalEventEmitter,n),r?._LocalEventEmitter&&r._LocalEventEmitter.dispatch(n,{dispatch:"ensurePosterUpdated"})},250))},[r?.watchData,r?.cdn?.static,n]);var $={id:r?.watchData?.id,authorData:r?.watchData?.authorData??{},donateTo:r?.watchData?.author??"",date:r?.watchData?.publish?resolveContentDate(r.watchData.publish):"",title:r?.watchData?.title??"",description:r?.watchData?.description??"",tags:r?.watchData?.tags??[],relevantTicket:m},tt=r.menuConfig&&r.menuConfig.height?r.menuConfig.height+2+"px":"35px";return React.createElement("div",{className:r.className+" WatchPage_Container"},React.createElement(Watch,_extends({},r,{chatState:p,handleSetMobileStyleConfigs:t=>{K!==t&&g(t)},menuHeight:tt,currentPoster:V,streamLeadPrompt:h,authContainer:P,WatchPageStyles:WatchPageStyles,watchMeta:$,playerInitialized:w,playerVisible:Y,playerName:n?"player-"+n:null,setMobileStyleConfigs:g,enforceAuth:l,setEnforceAuth:F,muted:E,handleSetMuted:t=>{_?.current?.muted&&(t=!!t,_.current.muted(t),b(t))}})))};export default Module;