function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a,c=arguments[e];for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a])}return t}).apply(this,arguments)}import React from"react";import dynamic from"next/dynamic";import WatchPageStyles from"./WatchPage.module.scss";import{useRouter}from"next/router";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream,checkAuthorization}from"../../utility/streaming";import{ensureAutoPlay,ensureSetSource}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia,isObjectEmpty}from"../../util";import{initializePlayer,disposePlayer,initButtons}from"/modules/streaming/watch/runtime/initialize";import{checkiOS}from"/modules/util";import{resolveContentDate}from"../../utility/utility/date";const Watch=dynamic(()=>import("/layout/Watch"),{ssr:!1}),defaultPoster="img/internal/videoposter.png";let options={autoplay:!0,html5:{vhs:{lowLatency:!0,minPlaylistRefreshIntervalMs:1500}}};const Module=u=>{const r=useRouter()["query"],[h,U]=React.useState(!1),[d,,]=React.useState("main-player"),[e,F]=React.useState(!1),[m,H]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[t,j]=React.useState(""),[a,z]=React.useState(!1);var[c,B]=React.useState(!1);const[p,N]=React.useState({}),[n,y]=React.useState({});var[,,]=React.useState(null);const[s,W]=React.useState({}),[g,w]=React.useState(defaultPoster),[i,l]=React.useState(!1),[V,o]=React.useState(!1),[R,v]=React.useState(!1),[b,f]=React.useState(!1),[D,k]=React.useState(!1);var[,,]=React.useState([]);const[q,S]=React.useState(!1),[E,_]=React.useState(null),[P,L]=React.useState(!1),[J,K]=React.useState({});let A=React.useRef();React.useRef(),React.useRef(),React.useRef();const T=React.useRef(),M=a||c,C=u.watchData,I=()=>{u._LocalEventEmitter.dispatch("video_set_chat_state",{})},[Y,$]=React.useState([{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",id:"player-btn-chat",btnEvent:I}]),G=(React.useEffect(()=>{let t=[{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",id:"player-btn-chat",btnEvent:I}];t=u?.appendButtons?t.push(u.appendButtons):u.overrideButtons??t,$(t)},[u?.appendButtons,u?.overrideButtons]),d&&(u._LocalEventEmitter.unsubscribe(d),u._LocalEventEmitter.subscribe(d,t=>{if(t&&t.dispatch)if(A?.current?.muted&&A?.current?.muted()!==P&&L(A.current.muted()),"updateAuth"===t.dispatch){if(ct(),!u?.watchData||isObjectEmpty(u.watchData))return null;!M&&T?.current?(e={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",p),A?.current?.src&&(A.current.src({src:"",type:"application/x-mpegURL"}),A.current.pause()),p&&(p.password&&(e.password="The stream requires a password"),p.tags)&&p.dates&&(0<p.tags.length||0<p.dates.length)&&(e.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",e.tagsList=p.tags.map(t=>t)+" "+p.dates.map(t=>t)),y(e)):M||y({})}else if("attemptAutoPlay"===t.dispatch){if(A?.current&&""!==A?.current.src()){console.log("Attempt Play",A.current,m);try{window?.userInteracted||A.current.muted(!0)}catch(t){}window?.imaPlaying||A.current.play().catch(t=>{console.log(t,t.message)})}}else{var e,a,c,r,n,s,i,l,o;"ensurePosterUpdated"===t.dispatch?u?.watchData&&u?.watchData?.thumbtrack&&u?.watchData?.thumbtrack[0]&&u?.cdn?.static&&(e=u.cdn.static+"/thumbtrack/"+u.watchData.thumbtrack[0],g!==e)&&w(e):"playerHealth"===t.dispatch?(console.log("Player Health",u.cdn,A.current,A.current?.paused(),E),!window?.imaAdManagerDidLoad&&u?.noAds||(E?.message?.match("Playback cannot continue")&&A?.current?.paused()||A?.current?.errorDisplay?.el()?.innerHTML.match("Playback cannot continue")||A?.current?.errorDisplay?.el()?.innerHTML.match("The media could not be loaded")&&D?(_(null),A.current.src({}),ensureSetSource(A.current,m,C,u.cdn.static,!0,()=>{try{window?.userInteracted||A.current.muted(!0)}catch(t){}window?.imaPlaying||(console.log("Attempting to play! Player Health Check"),A.current.play())})):A?.current&&u?.cdn?.static?ensureSetSource(A.current,m,C,u.cdn.static):A.current||q||((e=G("player-"+d))?(v(!0),A.current=e):(disposePlayer("player-"+d),S(!0),setTimeout(()=>{console.log("Fire Reload"),u._LocalEventEmitter.dispatch(d,{dispatch:"rebuildPlayer"})},50))))):"rebuildPlayer"===t.dispatch?(console.log("Reload Player"),S(!1),tt()):"checkLoad"===t.dispatch?(console.log("v",A?.current,R,window?.imaAdManagerDidLoad),h&&!R&&d&&u?.cdn?.static&&window?.videojs&&(window?.imaAdManagerDidLoad||!u?.noAds)&&(f(!0),A.current=initializePlayer(u,u.watchData,m,"player-"+d,options,A,Y,Q,X,v,et,k,D,Z))):"livestreamHealth"===t.dispatch&&"Live"===C?.__typename&&(e=G("player-"+d),t=document.getElementById(`player-${d}_html5_api`),console.log(t),e)&&(a=structuredClone(J),console.log("P",e),console.log("Tech",e.tech(),"Vhs",e.tech().vhs),c=e?.currentTime(),(!a.lastTime||c&&a?.lastTime&&a.lastTime!=c)&&(a.lastTime=c),r=e.tech().vhs,n=(e?.tech()?.vhs?.playlists?.media_)?.segments,Array.isArray(n)&&(i=(s=n.reduce((t,e)=>e?.end??t+(e?.duration??0),0))<c+8,l=s<c+4,o=n?.[2]?.end&&c<n[2].end-22,console.log("Current Time",c,"Near End",i,"Near End Critical",l,"Falling Behind",o,"Available Segment",s,"Playback Rate",t?.playbackRate,"Segments",n),t)&&(i?l?(.8<t.playbackRate&&(console.log("Slowing down critical playback rate",t.playbackRate),t.playbackRate=t.playbackRate-.05),(!a.lastFetch||a?.lastFetch&&a.lastFetch+3<(new Date).getTime())&&(console.log("Fetching more stream",r,e,e.seekable()),a.lastFetch=(new Date).getTime())):.9<t.playbackRate&&(console.log("Slowing down playback rate",t.playbackRate),t.playbackRate=t.playbackRate-.05):(t.playbackRate<1&&(console.log("Speeding up playback rate",t.playbackRate),t.playbackRate=t.playbackRate+.025),o?t.playbackRate<1.1&&(t.playbackRate=t.playbackRate+.025):1<t.playbackRate&&(t.playbackRate=t.playbackRate-.025)),1!==t.playbackRate)&&.98<t.playbackRate&&t.playbackRate<1.02&&(t.playbackRate=1),K(a))}})),t=>{try{if(window?.videojs?.players[t])return window.videojs.players[t]}catch(t){}return null}),Q=t=>{console.log("Error",t),_({time:(new Date).getTime(),message:t?.message??""})},X=t=>{console.log("Ended",t)},Z=t=>{console.log("Played",t)},tt=t=>{t=Object.assign(options,{force:t,html5:{vhs:{lowLatency:!0,minPlaylistRefreshIntervalMs:1500}}});!window?.imaAdManagerDidLoad&&u?.noAds||(A.current=initializePlayer(u,u.watchData,m,"player-"+d,t,A,Y,Q,X,v,et,k,D,Z))},et=(React.useEffect(()=>{u?._LocalEventEmitter&&(u._LocalEventEmitter.unsubscribe("video_set_chat_state"),u._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",i),l(!i)}))},[u._LocalEventEmitter,i]),React.useEffect(()=>{(async()=>{var t;e||u.watchData&&u.watchData.id&&(!s.stream||s.stream&&s.stream!==u.watchData.id)&&(F(!0),t=await doFetchAuthForStream(u.apiUrl,u.domainKey,u.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&W({stream:u.watchData.id,allowed:t.allowed||!1,meta:t.meta,products:t?.products??[]})})()},[u.watchData,s,e]),async(t,e)=>{var a,c;M&&(c={},r?.time&&(c.time=r.time),c?.time&&t?.currentTime&&t.currentTime(c.time),a="live"==(e="Live"==(c=e??u?.watchData)?.__typename?"live":"static")||checkiOS()?"hls":"mpd",c)&&u?.cdn?.static&&(e="static"==e?u.cdn.static+"/video/"+c[a]:""+c?.meta?.channel?.playbackUrl)&&(t.src({src:e,type:"hls"==a?"application/x-mpegURL":"application/dash+xml"}),await ensureAutoPlay(t.play,t),setTimeout(()=>{u._LocalEventEmitter.dispatch(d,{dispatch:"attemptAutoPlay"})},1))});let O=d;React.useEffect(()=>{console.log("did mount",h,R,d,window.videojs);try{if(!h){U((new Date).getTime()),disposePlayer("player-"+d);const t=O;setInterval(()=>{u._LocalEventEmitter.dispatch(t,{dispatch:"updateAuth"})},2e3),setInterval(()=>{u._LocalEventEmitter.dispatch(t,{dispatch:"playerHealth"})},15e3),setInterval(()=>{u._LocalEventEmitter.dispatch(t,{dispatch:"checkLoad"})},2500),setInterval(()=>{u._LocalEventEmitter.dispatch(t,{dispatch:"livestreamHealth"})},1500)}}catch(t){}},[h,A.current,m,u.cdn,u.watchData,R,d,M,a]);const at=()=>{n?.type&&["prompt","auth"].indexOf(n.type)&&(console.log("Reset prompt"),y({}))},ct=(React.useEffect(()=>{let t;var e;"Live"==C?.__typename&&C?.id?(l(!0),C?.meta?.channel?.playbackUrl&&m.src!==C.meta.channel.playbackUrl&&(t=C.meta.channel.playbackUrl)):"Video"==C?.__typename&&(l(!1),e=checkiOS()?"hls":"mpd",C)&&C[e]&&u?.cdn?.static&&(e=u.cdn.static+"/video/"+C[e],m.src!==e)&&(t=e),t&&m.src!==t&&((e={...m}).src=t,H(e),handleInteractMedia(u,u.watchData,e.trying))},[u.watchData,A.current,m?.src,C]),React.useEffect(()=>{m?.src&&t!==m.src&&j(m.src)},[A?.current,m?.src,M,a,t,C,n]),A?.current&&A?.current.src()!==m?.src&&C&&(x="live"==("Live"==C?.__typename?"live":"static")||checkiOS()?"hls":"mpd",A.current.src({src:t,type:"hls"==x?"application/x-mpegURL":"application/dash+xml"})),()=>{var t,e,a;u.watchData&&(t=checkAuthorization(u.watchData,s,u,at,M),u.watchData.meta&&u.watchData.meta.streamSettings&&JSON.stringify(u.watchData.meta.streamSettings)!==JSON.stringify(p)&&N(u.watchData.meta.streamSettings),M!==t)&&(e=u.watchData?.meta?.channel&&u.watchData.meta?.channel?.playbackUrl&&m?.src===u.watchData.meta.channel.playbackUrl,a=u?.watchData?.hls||u?.watchData?.mpd,e||a)&&(z(t),t&&at(),console.log("Auth",t))});React.useEffect(()=>{ct()},[m,M,a,u?.watchData,A?.current,s,u?._loggedIn?.identifier]);React.useEffect(()=>{var t;u?.watchData&&u?.watchData?.thumbtrack&&u?.watchData?.thumbtrack[0]&&u?.cdn?.static&&(t=u.cdn.static+"/thumbtrack/"+u.watchData.thumbtrack[0],g!==t)&&(w(t),setTimeout(()=>{console.log(u._LocalEventEmitter,d),u?._LocalEventEmitter&&u._LocalEventEmitter.dispatch(d,{dispatch:"ensurePosterUpdated"})},250))},[u?.watchData,u?.cdn?.static,d,g]);var x={id:u?.watchData?.id,authorData:u?.watchData?.authorData??{},donateTo:u?.watchData?.author??"",date:u?.watchData?.publish?resolveContentDate(u.watchData.publish):"",title:u?.watchData?.title??"",description:u?.watchData?.description??"",tags:u?.watchData?.tags??[],relevantTicket:s},rt=(A?.current&&(R||v(!0),b||f(!0)),u.menuConfig&&u.menuConfig.height?u.menuConfig.height+2+"px":"35px");return console.log(A?.current,M,m,"Relevant Data",u.watchData,s),React.createElement("div",{className:u.className+" WatchPage_Container"},React.createElement(Watch,_extends({},u,{chatState:i,handleSetMobileStyleConfigs:t=>{V!==t&&o(t)},menuHeight:rt,currentPoster:g,streamLeadPrompt:n,authContainer:T,WatchPageStyles:WatchPageStyles,watchMeta:x,playerInitialized:R,playerVisible:b,playerName:O?"player-"+O:null,setMobileStyleConfigs:o,enforceAuth:c,setEnforceAuth:B,muted:P,handleSetMuted:t=>{A?.current?.muted&&(t=!!t,A.current.muted(t),L(t))}})))};export default Module;