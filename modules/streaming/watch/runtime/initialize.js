import{handleInteractMedia}from"/modules/util";import{HMSDurationToSeconds}from"/modules/utility/utility/date";const disposePlayer=e=>{try{var t;window?.videojs?.players&&(t=window.videojs.players)&&Object.keys(t).length&&t[e]&&t[e].dispose()}catch(e){}},setTimeline=(o,e)=>{console.log(o,e,window?.VTTCue);try{if(o&&e?.timeline&&window?.VTTCue){const a=o.addRemoteTextTrack({kind:"metadata",mode:"showing"},!1).track,s=e.timeline.filter(e=>"clip"===e.type),l=e?.duration?HMSDurationToSeconds(e.duration):0,r=o?.controlBar?.progressControl?.el();s.forEach((e,t)=>{var i=e.startOffset,n=e?.endOffset??(s[t+1]&&s[t+1].startOffset)?s[t+1].startOffset-1:l??0,e=e.name,n=new window.VTTCue(i,n,e);a.addCue(n),r&&o?.id_&&(0===t&&((e=document.createElement("div")).className="segmentContainer",e.id=o.id_+"_segmentContainer",r.appendChild(e)),(n=document.getElementById(o.id_+"_segmentContainer"))&&((t=document.createElement("div")).classList.add("vjs-segment-square"),e=i/l*100,t.style.left=e+"%",n.appendChild(t)),console.log("Seek",r))}),o.on("timeupdate",function(){})}}catch(e){}},initButtons=async(t,i)=>{for(let e=0;e<i.length;e++){var n,o;i[e]?.id&&!document.getElementById(i[e].id)&&((o=(n=t.current.controlBar.addChild("button")).el()).innerHTML=i[e].innerHTML??"",i[e].className&&n.addClass(i[e].className),o.id=i[e].id,i[e].btnEvent)&&(o.removeEventListener("click",i[e].btnEvent),o.addEventListener("click",i[e].btnEvent))}},initializePlayer=(t,i,n,o,e,a,s=[],l,r,d,c,u,g,y)=>{try{if(window.videojs){if(console.log("Run Init",o,document.getElementById(o)),window.videojs.log.level("debug"),window.videojs.Vhs.GOAL_BUFFER_LENGTH=100,window.videojs.Vhs.MAX_GOAL_BUFFER_LENGTH=150,!window.videojs.players[o]||e.force)return window.videojs(o,e,async function(){a?.current&&(d&&d(!0),window.videojs.log(`Your player ${o} is ready!`),console.log(a.current),initButtons(a,s),this.on("error",e=>{console.log("Error",e,o),l&&l(e)}),this.on("ready",e=>{i?.id&&t&&n?.trying&&(handleInteractMedia(t,t.watchData,n.trying),setTimeline(this,i)),c&&c(e?.target?.player??this,i)}),this.on("play",e=>{console.log("Play event",e),y&&y(e),u&&u(!0)}),this.on("waiting",e=>{console.log("Player is buffering"),this.lastBufferWaiting=(new Date).getTime(),setTimeout(()=>{null===this.lastBufferWaiting||window.imaPlaying||this.play()},5e3)}),this.on("stalled",e=>{console.log("Player is stalled")}),this.on("progress",e=>{(!this.lastProgressUpdate||this.lastProgressUpdate<(new Date).getTime()-7500)&&(l&&l(e,"update","progress"),this.lastProgressUpdate=(new Date).getTime()),null!==this.lastBufferWaiting&&(this.lastBufferWaiting=null)}),this.on("ended",e=>{console.log("Ended",o),r&&r()}))});if(document.getElementById(o)){var m=document.getElementById(o);if(console.log(`Player ${o} already initialized`,m,m?.player.hasStarted(),g),!m?.player?.hasStarted())try{try{!window?.userInteracted&&m?.player&&m.player.muted(!0)}catch(e){}m.player.play()}catch(e){console.log("Failed to play",e)}}}}catch(e){}};export{disposePlayer,initializePlayer,initButtons};