import{handleInteractMedia}from"/modules/util";import{HMSDurationToSeconds}from"/modules/utility/utility/date";const disposePlayer=e=>{try{var t;window?.videojs?.players&&(t=window.videojs.players)&&Object.keys(t).length&&t[e]&&t[e].dispose()}catch(e){}},setTimeline=(o,e)=>{console.log(o,e,window?.VTTCue);try{if(o&&e?.timeline&&window?.VTTCue){const a=o.addRemoteTextTrack({kind:"metadata",mode:"showing"},!1).track,s=e.timeline.filter(e=>"clip"===e.type),l=e?.duration?HMSDurationToSeconds(e.duration):0,d=o?.controlBar?.progressControl?.el();s.forEach((e,t)=>{var n=e.startOffset,i=e?.endOffset??(s[t+1]&&s[t+1].startOffset)?s[t+1].startOffset-1:l??0,e=e.name,i=new window.VTTCue(n,i,e);a.addCue(i),d&&o?.id_&&(0===t&&((e=document.createElement("div")).className="segmentContainer",e.id=o.id_+"_segmentContainer",d.appendChild(e)),(i=document.getElementById(o.id_+"_segmentContainer"))&&((t=document.createElement("div")).classList.add("vjs-segment-square"),e=n/l*100,t.style.left=e+"%",i.appendChild(t)),console.log("Seek",d))}),o.on("timeupdate",function(){})}}catch(e){}},initButtons=async(t,n)=>{for(let e=0;e<n.length;e++){var i,o;n[e]?.id&&!document.getElementById(n[e].id)&&((o=(i=t.current.controlBar.addChild("button")).el()).innerHTML=n[e].innerHTML??"",n[e].className&&i.addClass(n[e].className),o.id=n[e].id,n[e].btnEvent)&&(o.removeEventListener("click",n[e].btnEvent),o.addEventListener("click",n[e].btnEvent))}},initializePlayer=(t,n,i,o,e,a,s=[],l,d,r,c,u,y,m)=>{try{if(window.videojs){if(console.log("Run Init",o,document.getElementById(o)),window.videojs.log.level("debug"),window.videojs.Vhs.GOAL_BUFFER_LENGTH=100,window.videojs.Vhs.MAX_GOAL_BUFFER_LENGTH=150,!window.videojs.players[o]||e.force)return window.videojs(o,e,async function(){a?.current&&(r&&r(!0),window.videojs.log(`Your player ${o} is ready!`),console.log(a.current),initButtons(a,s),this.on("error",e=>{console.log("Error",o),l&&l(e)}),this.on("ready",e=>{n?.id&&t&&i?.trying&&(handleInteractMedia(t,t.watchData,i.trying),setTimeline(this,n)),c&&c(e?.target?.player??this,n)}),this.on("play",e=>{m&&m(e),u&&u(!0)}),this.on("waiting",e=>{console.log("Player is buffering"),this.lastBufferWaiting=(new Date).getTime(),setTimeout(()=>{null!==this.lastBufferWaiting&&this.play()},5e3)}),this.on("stalled",e=>{console.log("Player is stalled")}),this.on("progress",e=>{console.log("Player is progressing"),this.lastBufferWaiting=null}),this.on("ended",e=>{console.log("Ended",o),d&&d()}))});if(document.getElementById(o)){var g=document.getElementById(o);if(console.log(`Player ${o} already initialized`,g,g?.player.hasStarted(),y),!g?.player?.hasStarted())try{try{window?.userInteracted||g.player.muted(!0)}catch(e){}g.player.play()}catch(e){console.log("Failed to play",e)}}}}catch(e){}};export{disposePlayer,initializePlayer,initButtons};