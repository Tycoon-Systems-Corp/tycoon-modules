function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,i=arguments[t];for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e}).apply(this,arguments)}import React from"react";import apiReq from"/modules/utility/api/apiReq";import{v4 as uuidv4}from"uuid";import{setAndPlay}from"/modules/video/player/utility";import{initializePlayer,disposePlayer}from"/modules/streaming/watch/runtime/initialize";import{checkiOS,debounce,resolveNestedProperty}from"/modules/util";import Upload from"/modules/video/upload/class/Upload";import{fetchVideos}from"/modules/video/upload/tools";import UploadVideo from"/layout/upload/UploadVideo";const ASSOCIATE_RECORDS=["product","video","article"],ASSOCIATION_METHODS=["authorize","related"],Module=o=>{const[e,t]=React.useState(null),[a,i]=React.useState(!1),[c,s]=React.useState(null),[r,d]=React.useState(null),[l,n]=React.useState(null),[u,p]=React.useState(!1),[m,R]=React.useState(!1),[f,S]=React.useState(!1),[g,h]=React.useState(!1),[v,y]=React.useState(null),[A,E]=React.useState(20),[O,x]=React.useState(!1);var[k,L]=React.useState(ASSOCIATE_RECORDS[0]);const[b,N]=React.useState(10);var[q,F]=React.useState(ASSOCIATION_METHODS[0]);const[P,C]=React.useState([]),[H,j]=React.useState({message:""}),[I,$]=React.useState({action:"page_loaded",trying:"play_video",src:""}),_=React.useRef(),D=React.useRef();var B=React.useRef(),W=React.useRef();React.useEffect(()=>{var e;a||(e=uuidv4(),s(e),i(!0))},[a,c,f]),o._LocalEventEmitter.unsubscribe(c),o._LocalEventEmitter.subscribe(c,e=>{var t;e&&("fetchVideos"===e.dispatch?A<100&&(t=A+20,E(t),T(0,t)):"initializeVideosHandler"===e.dispatch&&G())});const Y=React.useCallback(debounce(e=>{e?.target&&e.target.scrollLeft+e.target.offsetWidth>e.target.scrollWidth-300&&!g&&o._LocalEventEmitter.dispatch(c,{dispatch:"fetchVideos"})},500),[A,g,v]),G=()=>{D?.current&&!O&&(x(!0),D.current.addEventListener("scroll",Y))},T=(React.useEffect(()=>{!o._loggedIn||g||v||(T(0,A),z(ASSOCIATE_RECORDS[0],b))},[o?._loggedIn,g,A]),async(e,t)=>{e=await fetchVideos(o,e,t,h,g,c);e&&y(e)});var J=React.useCallback(e=>{t(null)});const w=(e,t)=>{var a=t??r;const i=checkiOS()?"hls":"mpd";if(t&&t[i]){const s=o.cdn.static+"/video/"+a[i];_.current?setAndPlay(s,i,_.current):setTimeout(()=>{setAndPlay(s,i,_.current)},5e3)}},V=r=>{let e=r;r instanceof Upload?d(r):(e=new Upload(o._loggedIn.identifier,r),d(e)),e.player||(e.player=_),n(e.getInstance()),setTimeout(()=>{e?.usePayload&&Object.entries(e.usePayload).map(t=>{var a,i,s=document.querySelector(`[selectelement="${c}-${t[0]}"]`);if(s){let e=resolveNestedProperty(r,t[1].path);"date"===t[1].type&&(t=new Date(Number(e)))&&(a=(t.getMonth()+1).toString(),i=t.getDate().toString(),e=`${t.getFullYear()}-${a.padStart(2,"0")}-`+i.padStart(2,"0")),s.value=e}})},150)},M=(e,t,a="player-"+c)=>{var i,s;V(e),r?.updatedFields&&!t&&(r.updatedFields={}),c&&(f?w(_.current,e):(t=w,e=e,a=a,s=checkiOS()?"hls":"mpd",e&&e[s]&&(s=o.cdn.static+"/video/"+e[s],(i={...I}).src=s,$(i),_.current=initializePlayer(o,e,I,a?"player-"+c:null,{},_,[],null,null,S,t))))};o._LocalEventEmitter.unsubscribe("uploadUpdate"),o._LocalEventEmitter.subscribe("uploadUpdate",e=>{e?.message&&(-1<["Ready to watch","Began processing video"].indexOf(e.message)&&T(0,A),j({message:e.message})),(e?.record?.id&&r?.getInstance()?.id&&e.record.id===r.getInstance().id||-1<["Video queued for processing","Began processing video"].indexOf(e.message))&&M(e.record)});var K=React.useCallback(e=>{if(e?.currentTarget?.getAttribute("item")){const t=e.currentTarget.getAttribute("item");if(t){const a=v.find(e=>e.id===t);a&&new Promise((e,t)=>{e(R(!0))}).then(()=>{M(a)})}}}),Q=React.useCallback(e=>{R(!1),V(null),r?.updatedFields&&(r.updatedFields={}),p(!1)},[r]);React.useEffect(()=>{!m&&_?.current&&_.current.pause()},[m,_?.current]);const U=async(e,t)=>{let a;var i=[...v],t=t??r;return e&&("publish"===e?a=await t.setPublish(o,!0):"unpublish"===e?a=await t.setPublish(o,!1):"private"===e?a=await t.setPrivate(o,!0):"unprivate"===e?a=await t.setPrivate(o,!1):"update"===e&&(a=await t.setUpdate(o))),a?.id&&(V(a),-1<(e=i.findIndex(e=>e.id===a.id))&&(i[e]=a),y(i)),{video:a,videos:i}};var X=React.useCallback(e=>{e=e?.currentTarget?.getAttribute("modif");U(e)},[r]);const z=async(e,t)=>{var a=e+"Req",e=(N(t),"product"===e||"article"===e?"created":"creation"),t=await apiReq("/fetch/fetchhandler",{handlerArgs:[{[a]:[{author:o?._loggedIn.identifier,limit:t,offset:0,sortField:e,sort:"desc"}]}]});"success"===t?.status&&t?.data?.fetchedData&&t.data.fetchedData[0]&&t.data.fetchedData[0][a]&&t.data.fetchedData[0][a][0]&&(e=t.data.fetchedData[0][a][0],C(e))};console.log(o,r,f,I,v,P);var Z=0<v?.length?v:Array(20).fill().map(()=>{});return React.createElement("div",null,React.createElement(UploadVideo,_extends({},o,{ASSOCIATE_RECORDS:ASSOCIATE_RECORDS,ASSOCIATION_METHODS:ASSOCIATION_METHODS,handleClearError:J,setPageError:t,pageError:e,setProcessing:p,processing:u,handlingMeta:m,setHandlingMetaProxy:e=>{R(e),f||setTimeout(()=>{_.current=initializePlayer(o,null,I,"player-"+c,{},_,[],null,null,S,null)},250)},setVideoDocumentProxy:V,fetchBusy:g,useVideos:Z,videosContainerRef:D,loadVideo:K,status:H,componentId:c,initialized:f,setInitialized:S,videoDocumentRasterized:l,clipStartRef:B,clipDescriptionRef:W,currentAssociation:k,currentAssociationMethod:q,associateRecords:P,videoDocument:r,handlePublish:X,handleStartUpload:Q,setVideoDocumentRasterized:n,setCurrentAssociation:L,setCurrentAssociationMethod:F,getAssociateAttributes:z,currentAssociationLimit:b,setAssociateRecords:C,loadRecord:M,handleDisposePlayer:e=>{disposePlayer(e??"player-"+c),S(!1)},publish:U,noAds:!0})))};export default Module;