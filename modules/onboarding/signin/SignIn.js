function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}import React from"react";import apiReq from"/modules/utility/api/apiReq";import{useRouter}from"next/router";import{checkSignedIn,attemptThirdPartySignIn}from"../../utility/onboarding/SignIn";import{setStripeSecretData}from"../../utility/payment/index";import{fetchPost}from"../../utility/fetch";import{SignInOnboard,RegisterOnboard}from"/layout/onboarding";import{debounce}from"../../util";import{handleLookupUsernameRequest}from"./tools";import{fireGlobalEvent}from"../../utility/utility";const Module=r=>{const t=useRouter(),n=t["asPath"];let i=React.useRef();const[e,a]=React.useState(!1),[o,s]=React.useState(!1);let[,l]=React.useState(!1),[c,u]=React.useState(!1),[d,g]=React.useState(!1);const[m,h]=React.useState(!1),[p,R]=React.useState(!1),[f,S]=React.useState(null),[v,_]=React.useState({});let[I,y]=React.useState(null);const E=React.useRef(),b=React.useRef(),w=React.useRef(),A=(React.useEffect(()=>{a(!0)},[e]),r._LocalEventEmitter.unsubscribe("showSignIn"),r._LocalEventEmitter.subscribe("showSignIn",e=>{g(!1),h(!1),L(500)}),r._LocalEventEmitter.unsubscribe("checkAdminAuth"),r._LocalEventEmitter.subscribe("checkAdminAuth",e=>{O(!0)}),React.useEffect(()=>{document.addEventListener("mute-login-error",()=>{y(null)},{once:!0})},[]),async e=>{e=await attemptThirdPartySignIn(e,r.apiUrl,r.domainKey,r._LocalEventEmitter,r._setAdminAuth,y);e?.data&&e?.data.hasOwnProperty("username")&&(e.data.username||l(!0)),"error"!=typeof e&&(setStripeSecretData(r.apiUrl,r.domainKey,e,r._setStripeSecret),r._setLoggedIn(e.data),console.log(r.redirectOnAuth,e.username),"/admin"===n&&setTimeout(()=>{r._LocalEventEmitter.dispatch("checkAdminAuth",{})},1e3),r.redirectOnAuth&&e?.data?.username&&n!==r.redirectOnAuth?t.push(r.redirectOnAuth):r.redirectOnAuth&&e?.data?.username&&n===r.redirectOnAuth&&t.reload(r.redirectOnAuth),setTimeout(()=>{y(null)},2e4),setTimeout(()=>{g(!0),h(!0)}))}),L=(e,t,n=0)=>{try{if(!c||t){const a={theme:"outline",size:"medium",logo_alignment:"center"};setTimeout(()=>{try{var e=checkSignedIn();e?r._setLoggedIn(e):(google.accounts.id.renderButton(i.current,a),u(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){setTimeout(()=>{try{var e=checkSignedIn();e?r._setLoggedIn(e):(google.accounts.id.renderButton(i.current,a),u(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){console.log(e)}},1e4)}},e)}else n<5&&setTimeout(()=>{L(e,t,n+1)},e)}catch(e){console.log(e)}},O=(React.useEffect(()=>{document.removeEventListener("thirdparty-signin",A),document.addEventListener("thirdparty-signin",A),L(500)},[]),async e=>{(r?.path.match(/\/admin/)&&!o||e)&&(console.log(r),r?._loggedIn?.identifier)&&r?._loggedIn?.hash&&r?.domainKey&&!r._adminAuth&&r?._setAdminAuth&&(s(!0),(e=await(async(e,t,n,a)=>{if(t)return!!(e=await fetchPost(e+"/m/checkadminauth",null,null,{identifier:t,hash:n,domainKey:a}))&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?e:void 0):void 0)})(r.apiUrl,r._loggedIn.identifier,r._loggedIn.hash,r.domainKey))?.admin)&&r._setAdminAuth(e.admin)});React.useEffect(()=>{r?._loggedIn?.identifier&&r?._adminAuth?.userid&&r._loggedIn.identifier!==r._adminAuth.userid&&r._setAdminAuth(null)},[r._loggedIn,r._adminAuth]),O();var k=React.useCallback(e=>{(async()=>{E?.current?.value&&await apiReq("/onboarding/signinunregistered",{email:E?.current?.value,password:b?.current?.value,signIn:!0,props:r,setPageError:y})})()}),C=React.useCallback(e=>{(async()=>{E?.current?.value&&await apiReq("/onboarding/signinunregistered",{email:E?.current?.value,password:b?.current?.value,username:w?.current?.value,register:!0,props:r,setPageError:y})})()}),P=()=>{if(u(!1),L(500,!0),p)return R(!1),!1;R(!0)},T=(()=>{try{var e=document.getElementsByClassName("google-sign-in-btn");return e&&e[0]&&0<e[0].children.length&&e[0].children[0]?!0:!1}catch(e){return!1}})(),x=React.useCallback(e=>{y(null)}),U=d&&m||r?._loggedIn;const q=React.useCallback(debounce(async e=>{e=await handleLookupUsernameRequest(e?.target?.value);e?.data&&S(e)},1500),[]);var K=React.useCallback(async e=>{S(null),q(e)},[]),j=React.useCallback(e=>{S(null)}),D=React.useCallback(e=>{if(E?.current?.value){var t=E.current.value;if(v[t]&&v[t]>(new Date).getTime()-12e4)return!1;var n=v,n=(n[t]=(new Date).getTime(),_(n),{event:"reset_password",data:{email:t}});r?._LocalEventEmitter&&r._LocalEventEmitter.dispatch("global_event",n);try{window.dispatchEvent(new CustomEvent("global_event",{detail:Object.assign({},n)}))}catch(e){}}},[r?._LocalEventEmitter]);return React.createElement("div",{className:`${r.className} ${r._loggedIn||!T?"":r.classNameOnLoaded} SignIn_Container `+(r.noStyle?"":"SignIn_ContainerOn"),style:{width:r?.width??null,maxWidth:r?.width??null,margin:"0 auto"}}," ",r?._loggedIn?null:r?.loadRegister||p?React.createElement(RegisterOnboard,_extends({},r,{emailRef:E,passwordRef:b,usernameRef:w,handleRegisterManual:C,hideSignIn:m,allhidden:U,hideGoogleSignIn:d,googleSignInIsLoaded:T,googleSignInRendered:c,googleSignIn:i,handleSetLoadRegister:P,pageError:I,handleClearPageError:x,availableUsername:f,handleLookupUsername:K,handleClearUsername:j})):React.createElement(SignInOnboard,_extends({},r,{emailRef:E,passwordRef:b,handleSignInManual:k,hideSignIn:m,allhidden:U,hideGoogleSignIn:d,googleSignInIsLoaded:T,googleSignInRendered:c,googleSignIn:i,handleSetLoadRegister:P,pageError:I,handleClearPageError:x,handleSetResetPassword:D})))};export default Module;