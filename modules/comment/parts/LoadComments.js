function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,s=arguments[t];for(a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e}).apply(this,arguments)}import React from"react";import{v4 as uuidv4}from"uuid";import apiReq from"/modules/utility/api/apiReq";import WatchPageStyles from"/modules/streaming/watch/WatchPage.module.scss";import{ReadComment}from".";import{submitPost}from"/modules/utility/utility/comment";const Module=r=>{const[e,a]=React.useState(!1),[,t]=React.useState(!1),[s,c]=React.useState(null),[i,l]=React.useState(!1),[,m]=React.useState(-1),[o,n]=React.useState(null),[d,u]=React.useState([]),[p,h]=React.useState(0),[w,f]=React.useState(null),[R,g]=React.useState(null),v=r?.useId??r?.commentUseParent,E=(r?.pipe&&(r._LocalEventEmitter.unsubscribe(r.pipe),r._LocalEventEmitter.subscribe(r.pipe,e=>{if(e&&"comment_published"===e.dispatch&&e?.comment){var t,a,s,o=[...d];const n=e?.comment?.meta?.opId;n?-1<(t=d.findIndex(e=>e.id===n))&&(o[t].replies||(o[t].replies=[]),(a=[...o[t].replies]).push(e.comment),(s={...o[t]}).replies=a,o[t]=s):o.unshift(e.comment),e.comment?.meta?.opId&&r._LocalEventEmitter.dispatch(e.comment.meta.opId,{dispatch:"comment_published",comment:e.comment}),u(o)}})),r._LocalEventEmitter.unsubscribe(o),r._LocalEventEmitter.subscribe(o,e=>{if(e&&"scroll_window"===e.dispatch){var t,e=document.body,a=document.documentElement,s=e?.scrollHeight??0,e=e?.offsetHeight??0,o=a?.clientHeight??0,n=a?.scrollHeight??0,a=a?.offsetHeight??0,c=window?.scrollY+window?.innerHeight,s=Math.max(s,e,o,n,a);if(!i)try{s-(window?.innerHeight<450?window.innerHeight/2:600)<c&&(null===R||R?.scrollY>window?.scrollY+50||R?.scrollY<window?.scrollY-50)&&(g({scrollX:window?.scrollX,scrollY:window?.scrollY}),t=p+25,h(t),l(!0),E(v,t))}catch(e){}}}),React.useEffect(()=>{if(!e){const t=uuidv4();try{window.addEventListener("scroll_window",function(e){r._LocalEventEmitter.dispatch(t,{dispatch:"scroll_window"})})}catch(e){}g({scrollX:window?.scrollX,scrollY:window?.scrollY}),n(t),a(!0)}},[e]),React.useEffect(()=>{i||v&&v!==s&&(l(!0),t(!0),E(v,p))},[v,i,s]),async(e,t,a,s)=>{try{c(e);var o,n=await apiReq("/p/getposts",{apiUrl:r?.apiUrl,id:e,offset:t,par:a,parentOffset:s,orderDir:r?.orderDir??null});n?.data?(m((new Date).getTime()),l(!1),0<t&&!a&&!s?(o=[...d].concat(n.data),u(o)):u(n.data)):(l(!1),f({dispatch:"error",message:n?.message??"Failed to get posts"}))}catch(e){l(!1)}});var b=React.useCallback(e=>{f(null)});const y=React.useCallback((e,t,a,s,o,n)=>{console.log("Handle Post",e,t);var c=r?.commentUseParent??"",i=r?.commentUseParentType??"";submitPost(e,r,t,a,c,i,s,o,n)});var _=React.useMemo(()=>d.map((e,t)=>React.createElement("div",{key:t},React.createElement(ReadComment,_extends({},r,{commentData:e,i:t,handlePost:y,sub:e})))),[d]);return React.createElement("div",{className:r.className+" AddComment_Container"},d?.map?React.createElement("div",{className:`${WatchPageStyles.readCommentsListContainer} ${WatchPageStyles.readCommentsListContainerOp} Post_ReadCommentsListContainer`},_):null,React.createElement("div",{className:`spinner spinnerBig ${i?"opacity1":"opacity0 spinnerHide"} spinnerRelative`,style:{marginTop:i?"1rem":0}}),w?React.createElement("div",{className:"error CommentForceNoBlur",style:{margin:".25rem",marginBottom:"0"},onClick:b},w.message):null)};export default Module;