function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}import React from"react";import{useRouter}from"next/router";import GridList from"../../video/player/gridList";import shopStyles from"./Shop.module.scss";import PIMStyles from"../product/ProductImageManager.module.scss";import{compareObjects,isObjectEmpty,getFormattedDate,getFormattedTime}from"../../util";import{v4 as uuidv4}from"uuid";import AllInclusive from"@mui/icons-material/AllInclusive";import ConfirmationNumber from"@mui/icons-material/ConfirmationNumber";import Inventory from"@mui/icons-material/Inventory";import Stadium from"@mui/icons-material/Stadium";import Tooltip from"@mui/material/Tooltip";import TextareaAutosize from"react-textarea-autosize";import{doPublishProduct,resolveImg,resolveStyles}from"../../utility/ecommerce";import{Lineup,ProductInternal,ProductImageManager}from"../product";import{SignIn,Username}from"../../onboarding/signin";import{doSetOptionsMetaData}from"./Functions";const defaultEditingOptionsMeta={description:"",productType:"virtual",ticket:!1,livestream:!1,livestreamDef:{dates:[],tags:[],input:""},eventDateDef:{dates:[],input:""},lineup:[]},defaultDefinePriceCurrency={code:"US",name:"United States",payment:"stripe",region:"NORTH AMERICA",currency:"USD",symbol:"$"},Module=o=>{const s=useRouter(),[t,L]=React.useState(!1),[,F]=React.useState(null),[l,u]=React.useState(!1);var[,,]=React.useState({});const[n,,]=React.useState([]),[a,c]=React.useState([]),[d,p]=React.useState({}),[i,g]=React.useState(null),[m,y]=React.useState(null),[f,v]=React.useState(Object.assign({},defaultEditingOptionsMeta)),[h,U]=React.useState(null),[q,B]=React.useState({}),[b,K]=React.useState(null),[r,R]=React.useState(0),[H,J]=React.useState(!1),[S,C]=React.useState(defaultDefinePriceCurrency),[z,T]=React.useState(new FormData),[Q,O]=React.useState([]),I=React.useRef(),P=React.useRef(),E=React.useRef(),D=React.useRef(),N=React.useRef(),G=React.useRef(),V=React.useRef(),x=React.useRef(),_=React.useRef(),k=React.useRef(),$=(React.useEffect(()=>{var e=o.profile?"shopProfileData":"shop";if(o&&o[e]){var t=o[e].products&&Array.isArray(o[e].products)?o[e].products.concat(n):[],e=o[e].shop;for(let e=0;e<a.length&&compareObjects(a,t);e++);h&&e&&(!e||e.id)||U(e),0===a.length&&0!==t.length&&c(t)}},[o.shopData,o.shopProfileData,n,a]),(e=!0)=>{var t={sid:uuidv4(),quantity:100};return e&&(t.option=""),t}),W=()=>({price:10,currency:"USD",priceTable:{},sid:uuidv4(),style:"",option:[$(!1)]}),A=()=>({id:uuidv4(),title:"",description:"",time:null,image:""});var e=o._loggedIn&&o._loggedIn.identifier&&o.profileData&&o.profileData.user&&o.profileData.user.id&&o._loggedIn.identifier===o.profileData.user.id;const X=t=>{console.log(t),(h?.id||!h&&o?.forceOpenRedirectOnDone)&&(C(defaultDefinePriceCurrency),p(t),setTimeout(()=>{var e={...t};e.name=t.name,p(e)},200))},Y=React.useCallback(e=>{try{if(console.log("Start"),isObjectEmpty(d)&&(h?.id||o?.forceOpenRedirectOnDone)){const r=W();let t={id:uuidv4(),shop:h?.id??null,name:"",detailmeta:structuredClone(defaultEditingOptionsMeta),styles:[r],shipping:[],published:!1,images:[],protype:{type:"virtual",subscription:!1},infinite:!1,meta:{},files:{},new:!0};C(defaultDefinePriceCurrency),p(t),g(r.sid),R(null),K(null);var n=Object.assign({},defaultEditingOptionsMeta);n.productType="virtual",v(n),setTimeout(()=>{I.current.value=r.style,r.option[0]&&Object.hasOwnProperty.call(r.option[0],"option")&&(e=r.option[0].option??"",P.current.value=e);var e=document.getElementById(t.id);e?.offsetTop&&window?.scrollTo&&o._isMobile&&window.scrollTo({behavior:"smooth",top:e.offsetTop-5})},200)}}catch(e){console.log(e)}}),M=(React.useEffect(()=>{var e;t||(e=uuidv4(),F(e),o?.forceOpenRedirectOnDone&&Y(),L(!0))},[t,o?.forceOpenRedirectOnDone]),React.useCallback(e=>{C(defaultDefinePriceCurrency),p({})})),Z=React.useCallback(e=>{var t,n;console.log(e.currentTarget.value),e.currentTarget&&(t={...d},-1<(n=d.styles.findIndex(e=>e.sid===i))&&(t.styles[n].style=e.currentTarget.value),p(t))}),ee=React.useCallback(e=>{var t,n,r;console.log(e.currentTarget.value,m),e.currentTarget&&-1<(n=(t={...d}).styles.findIndex(e=>e.sid===i))&&(null==m&&y(d.styles[n].option&&d.styles[n].option[0]?d.styles[n].option[0].sid:""),console.log(n,t.styles[n].option,m),r=t.styles[n].option.findIndex(e=>e.sid===m),console.log(r),-1<r&&(t.styles[n].option[r].option=e.currentTarget.value??""),p(t))}),te=React.useCallback(e=>{var t,n,r;e.currentTarget&&-1<(n=(t={...d}).styles.findIndex(e=>e.sid===i))&&(console.log(n,i,t),r=1===t.styles[n].option.length?0:t.styles[n].option.findIndex(e=>e.sid===m),console.log(r),-1<r&&(isNaN(Number(e.currentTarget.value))||(t.styles[n].option[r].quantity=Number(e.currentTarget.value))),p(t))}),ne=React.useCallback(e=>{var t,n;e.currentTarget&&-1<(t=(e={...d}).styles.findIndex(e=>e.sid===i))&&(-1<(n=1===e.styles[t].option.length?0:e.styles[t].option.findIndex(e=>e.sid===m))&&(!Object.prototype.hasOwnProperty.call(e.styles[t].option[n],"quantity")||e.styles[t].option[n].quantity&&1e7!==e.styles[t].option[n].quantity?e.styles[t].option[n].quantity=Number(1e7):e.styles[t].option[n].quantity=1),p(e))}),re=React.useCallback(e=>{var t,n;e.currentTarget&&-1<(n=(t={...d}).styles.findIndex(e=>e.sid===i))&&(isNaN(Number(e.currentTarget.value))||("USD"===S?.currency?t.styles[n].price=Number(e.currentTarget.value):(t.styles[n].priceTable||(t.styles[n].priceTable={}),t.styles[n].priceTable[S.currency]=Number(e.currentTarget.value)),p(t)))}),ae=React.useCallback(t=>{if(console.log(t.currentTarget.value),t.currentTarget){g(t.currentTarget.value);const e=d.styles.findIndex(e=>e.sid===t.currentTarget.value);I.current.value=d.styles[e].style,console.log(d.styles),setTimeout(()=>{P&&P.current&&(P.current.value=d?.styles&&d.styles[e]&&d.styles[e]?.option&&d.styles[e]?.option[0]&&d.styles[e].option[0]?.option?d.styles[e].option[0].option:"",y(d.styles[e].option&&d.styles[e].option[0]?d.styles[e].option[0].sid:""),N.current)&&(N.current.selectedIndex=0)},250),E.current.value=d.styles[e].option&&d.styles[e].option[0]?d.styles[e].option[0].quantity:1,D.current.value=d.styles[e]?d.styles[e].price:1}}),ie=React.useCallback(t=>{var e;console.log(t.currentTarget.value),t.currentTarget&&-1<(e=d.styles.findIndex(e=>e.sid===i))&&(e=d.styles[e].option.find(e=>e.sid===t.currentTarget.value),console.log(e),e)&&(P.current.value=e.option,y(e.sid),E.current.value=e.quantity)}),oe=React.useCallback(e=>{var t={...d};t.styles.push(W()),p(t)}),se=React.useCallback(e=>{console.log(d,i);var t,n={...d},r=d.styles.findIndex(e=>e.sid===i);console.log(r),-1<r&&(t=$(),d.styles[r].option[0]&&!Object.hasOwnProperty.call(d.styles[r].option[0],"option")?(d.styles[r].option[0].option="",y(d.styles[r].option[0].sid)):(d.styles[r].option.push(t),y(t.sid))),p(n)}),le=React.useCallback(e=>{var t,n;e.currentTarget&&(e=e.currentTarget.value,(t={...f}).productType=e,(n={...d}).protype.type=e,p(n),v(t))}),ue=React.useCallback(e=>{console.log(e.currentTarget.checked,e.currentTarget.getAttribute("option")),doSetOptionsMetaData(e,f,d,p,v,r,R)});React.useCallback(e=>{var t;e.currentTarget&&e.currentTarget.getAttribute("option")&&(t={...f},"add"===e.currentTarget.getAttribute("option")?t.lineup&&t.lineup.length<10&&(t.lineup.push(A()),R(t.lineup.length-1),x.current.value="",_.current.value="",k.current.value=null):"remove"===e.currentTarget.getAttribute("option")?t.lineup&&0<t.lineup.length&&(t.lineup.pop(),R(-1<t.lineup.length-1?t.lineup.length-1:null),x.current.value="",_.current.value="",k.current.value=null):"setSelected"===e.currentTarget.getAttribute("option")&&(e=e.currentTarget.getAttribute("index"),isNaN(e)||(R(e),x.current.value=t.lineup[e].title,_.current.value=t.lineup[e].description,k.current.value=t.lineup[e].time)))});const ce=React.useCallback(e=>{var t;e.currentTarget&&e.currentTarget.getAttribute&&e.currentTarget.getAttribute("modif")&&"product_name"===e.currentTarget.getAttribute("modif")&&((t={...d}).name=e.currentTarget.value,p(t))}),w=(t,a,i=!1)=>{try{return(async()=>{if(l)return null;{B({});var e={...d};if(console.log(e),e.detailmeta={...f},console.log("Publish Product",e),""===e.name)return B({message:"Please enter a name for your product",location:"product_name"}),u(!1),1;const n=z,r=Q;b&&b.editing===e.id&&(b.images.forEach(t=>{console.log("Img",t),r.find(e=>e.name===t.name)||(n.append("image",t),r.push({name:t.name,modif:"productImg"}))}),n.delete("imgNames"),n.append("imgNames",JSON.stringify(r))),T(n),O(r),n.append("domainKey",o.domainKey),n.append("hash",o._loggedIn.hash),n.append("identifier",o._loggedIn.identifier),n.append("product",JSON.stringify(e)),n.append("shop",h?.id??null),n.append("status",t),n.append("existing",a),u(!0),setTimeout(()=>{u(!1)},1e4);e=await doPublishProduct(o.apiUrl,o.domainKey,h?.id??null,o._loggedIn,e,n);return console.log(e),e&&(T(new FormData),O([]),e.product)&&(o?.forceOpenRedirectOnDone&&(o.redirect?s.push(o.redirect):o.redirectToProduct&&e?.product?.product?.id&&s.push("/pr?p="+e.product.product.id)),e.product.products)&&(i||(c(e.product.products),C(defaultDefinePriceCurrency),p({})),u(!1)),e}})()}catch(e){return null}},de=React.useCallback(e=>{var t;e.currentTarget&&e.currentTarget.getAttribute&&e.currentTarget.getAttribute("modif")&&(t=e.currentTarget.getAttribute("modif"),e=e.currentTarget.getAttribute("existing"),w(t,e))});const pe=React.useCallback(e=>H?(J(!1),!1):(J(!0),!0)),ge=(t,e)=>{var n,r;return console.log("Product Value",t,e),t.new?((n=d).meta.currency=e,p(n),e):-1<(r=(n=[...a]).findIndex(e=>e.id===t.id))?(n[r].meta.currency=e,c(n),e):null},me=(e,t="lineup",n)=>{const r=z,a=Q;e&&(e.forEach(e=>{r.append("image",e),a.push({name:e.name,modif:t,id:n})}),r.append("imgNames",JSON.stringify(a))),T(r),O(a)},j=d&&d.styles?d.styles.find(e=>e.sid===i):null,ye=d&&j&&j.option&&(j.option.find(e=>e.sid===m)??1===j.option.length)?j.option[0]:null,fe=e=>{"USD"!==(e=e||S)?.currency&&j.priceTable&&Object.prototype.hasOwnProperty.call(j.priceTable,e.currency)?D.current.value=j.priceTable[e.currency]:j?.price&&(D.current.value=j.price)};console.log(e,h);var ve=h&&h.status&&"nonexistent"===h.status;return console.log(ve,d,b,S),console.log(f,r,j,a),React.createElement("div",{className:""+o.className},React.createElement("div",{className:l?"fetchNotBusy fetchBusy":"fetchNotBusy"}),React.createElement("div",{className:shopStyles.container+" "+(o.smaller?""+PIMStyles.smallContainer:null)},e&&!ve?React.createElement("div",{className:""+shopStyles.adminContainer},React.createElement("div",{className:"heading"},"Shop"),React.createElement("div",{className:"flex options",style:{gap:".25rem"}},React.createElement("button",{disabled:!isObjectEmpty(d),onClick:Y},"Create Product"),d&&!isObjectEmpty(d)?React.createElement("button",{onClick:M,modif:"save"},d.new?"Abandon":"Cancel"):null)):null,React.createElement("div",{className:"Product_flex_container"},d?.new?React.createElement(ProductInternal,_extends({},o,{product:d,apiUrl:o.apiUrl,domainKey:o.domainKey,_loggedIn:o._loggedIn,fetchBusy:l,setFetchBusy:u,_setLoggedIn:o._setLoggedIn,handleEdit:X,editing:d,setEditing:p,setCurrentName:ce,pageError:q,styleInput:I,setCurrentStyleName:Z,changeCurrentStyle:ae,resolveStyles:resolveStyles,selectedStyle:j,setCurrentOptionName:ee,optionInput:P,changeCurrentOption:ie,optionSelect:N,editingSelectedStyle:i,editingSelectedOption:m,priceInput:D,setCurrentPrice:re,selectedOption:ye,quantityInput:E,setCurrentQuantity:te,setInfinity:ne,addStyle:oe,addOption:se,onProductTypeChange:le,editingOptionsMeta:f,setEditingOptionsMeta:v,setOptionsMetaData:ue,handlePublishProduct:de,publishProduct:w,handleCancelProduct:M,nameRef:G,setEditingSelectedStyle:g,setEditingSelectedOption:y,setCombinedFeed:c,setCurrentLineupEditing:R,currentLineupEditing:r,defaultLineup:A,setCurrencySelect:V,changeCurrentCurrency:ge,currentDefinePriceCurrency:S,setCurrentDefinePriceCurrency:C,setDefaultPriceHtml:fe,appendFormData:me,passTempImages:e=>{K({editing:d.id,images:e})},handleSetIsSettingCurrency:pe})):null,a&&a.map&&!o.hideFeed?a.map((e,t)=>React.createElement(ProductInternal,_extends({},o,{product:e,key:t,apiUrl:o.apiUrl,domainKey:o.domainKey,_loggedIn:o._loggedIn,fetchBusy:l,setFetchBusy:u,_setLoggedIn:o._setLoggedIn,handleEdit:X,editing:d,setEditing:p,setCurrentName:ce,pageError:q,styleInput:I,setCurrentStyleName:Z,changeCurrentStyle:ae,resolveStyles:resolveStyles,selectedStyle:j,setCurrentOptionName:ee,optionInput:P,changeCurrentOption:ie,optionSelect:N,editingSelectedStyle:i,editingSelectedOption:m,priceInput:D,setCurrentPrice:re,selectedOption:ye,quantityInput:E,setCurrentQuantity:te,setInfinity:ne,addStyle:oe,addOption:se,onProductTypeChange:le,editingOptionsMeta:f,setEditingOptionsMeta:v,setOptionsMetaData:ue,handlePublishProduct:de,publishProduct:w,handleCancelProduct:M,nameRef:G,setEditingSelectedStyle:g,setEditingSelectedOption:y,setCombinedFeed:c,setCurrentLineupEditing:R,currentLineupEditing:r,defaultLineup:A,setCurrencySelect:V,changeCurrentCurrency:ge,currentDefinePriceCurrency:S,setCurrentDefinePriceCurrency:C,setDefaultPriceHtml:fe,appendFormData:me,handleSetIsSettingCurrency:pe}))):null)))};export default Module;